#!/bin/ash

# =============================================================================
# Find'N'Run - find and run apps very quickly
  Version=1.9
# March-May 2015 by SFR and L18L; GNU GPL applies
# http://www.murga-linux.com/puppy/viewtopic.php?t=98330
# Req.: Gtkdialog >= 0.8.3, grep, sort, cut, sed
# =============================================================================

export TEXTDOMAIN=find_n_run
export OUTPUT_CHARSET=UTF-8

APP_TITLE="$(gettext "Find'N'Run")-${Version}"
ABOUT="$(sed -n "4,7p" "$0" | cut -c2-)"

LOC1="${XDG_DATA_HOME}/applications/"
LOC2="/usr/local/share/applications/"
LOC3="/usr/share/applications/"
#LOC4="${HOME}/.local/share/applications/"

CONFIG="${HOME}/.findnrunrc"

# -----------------------------------------------------------------------------

#LANG=de_DE.UTF-8 # just for demo
LR=${LANG%.*} #ex:pt_BR
L=${LANG%_*}  #ex:pt

# -----------------------------------------------------------------------------

# Defaults
defOPEN=false

if [ -f "$CONFIG" ]; then
. "$CONFIG"
fi

# =============================================================================

[ "`which gtkdialog4 2>/dev/null`" ] && GTKDIALOG=gtkdialog4 || GTKDIALOG=gtkdialog

# -----------------------------------------------------------------------------

export GUI_ABOUT='
<window title="'${APP_TITLE}'" icon-name="edit-find" window-position="2">
  <vbox>
    <frame>
      <text justify="2" selectable="true" can-focus="false">
        <label>"'${ABOUT}'"</label>
      </text>
    </frame>
    <hbox homogeneous="true">
      <button ok>
        <action>closewindow:GUI_ABOUT</action>
      </button>
    </hbox>
  </vbox>
  <variable>GUI_ABOUT</variable>
</window>'

# -----------------------------------------------------------------------------

export GUI_MAIN='
<window title="'${APP_TITLE}'" icon-name="edit-find" window-position="2"  height-request="278">
  <vbox>    
    <hbox tooltip-text="'$(gettext "Run by double click or ENTER key")'">
      <text>
        <label>'$(gettext "Narrow search by input of some letters:")'</label>
      </text>
      <entry secondary-icon-stock="gtk-close">
        <variable>varENTRY</variable>
        <action>refresh:varLIST</action>
        <action signal="activate">grabfocus:varLIST</action>
        <action signal="secondary-icon-release">clear:varENTRY</action>
      </entry>
    </hbox>

    <tree enable-search="false" exported-column="0" column-visible="0|1" headers-visible="false">
      <variable>varLIST</variable>
      <label>Name|Loc</label>
      <input>grep -H -R -E "^Name(\['${LR}'\]|\['${L}'\])?=" '${LOC1}' '${LOC2}' '${LOC3}' --include="*.desktop" 2>/dev/null | sort -t= -k1,1 -d -r | sort -t: -u -k1,1 | sed "s#:Name\(\['${LR}'\]\|\['${L}'\]\)\?=#|#" | sort -t\| -k2 -f | grep -i "|.*${varENTRY}" | grep -F -i -- "${varENTRY}"</input>
      <action>X="$(grep -m1 "^Exec=" "${varLIST}" | cut -f2- -d "=")"; unset GUI_ABOUT GUI_MAIN varENTRY varLIST varCOMMENT varOPEN TEXTDOMAIN OUTPUT_CHARSET; eval ${X% \%*} &</action>
      <action signal="changed">clear:varCOMMENT</action>
      <action signal="changed">refresh:varCOMMENT</action>
      <action condition="active_is_false(varOPEN)">exit:EXIT</action>
    </tree>
    
    <statusbar has-resize-grip="false" tooltip-text="'$(gettext "Comment")'">
      <variable>varCOMMENT</variable>
      <input>grep -E "^Comment(\['${LR}'\]|\['${L}'\])?=" "${varLIST}" 2>/dev/null | sort -t= -k1,1 -d -r | cut -f2- -d "="</input>
    </statusbar>
     
    <hbox space-fill="false" space-expand="false">
      <checkbox use-underline="true">
        <label>'$(gettext "_Leave this window open")'</label>
        <default>'${defOPEN}'</default>
        <variable>varOPEN</variable>
        <action>echo -e "defOPEN=${varOPEN}" > "'${CONFIG}'"</action>
      </checkbox>
      <text space-fill="true" space-expand="true"><label>""</label></text>
 	  <button tooltip-text="'$(gettext "About")'">
	    <input file stock="gtk-about"></input>
	    <action>launch:GUI_ABOUT</action>
	  </button>
      <button tooltip-text="'$(gettext "Exit")'">
        <input file stock="gtk-quit"></input>
        <action>exit:EXIT</action>
      </button>
    </hbox>
        
  </vbox>
  <action signal="key-press-event" condition="command_is_true([ $KEY_SYM = Escape ] && echo true )">exit:EXIT</action>
  <action signal="delete-event">exit:abort</action>
</window>'

$GTKDIALOG -p GUI_MAIN

###############################################################################
